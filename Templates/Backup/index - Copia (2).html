<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mercado Livre Keywords</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 50px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">Mercado Livre Keywords</h1>
        <form id="search-form" class="mb-4">
            <div class="form-group">
                <label for="category">Categoria:</label>
                <select class="form-control" id="category" required>
                    <option value="">Selecione uma categoria</option>
                </select>
            </div>
            <div class="form-group">
                <label for="subcategory">Subcategoria:</label>
                <select class="form-control" id="subcategory" disabled>
                    <option value="">Selecione uma subcategoria</option>
                </select>
            </div>
            <div class="form-group">
                <label for="subitem">Subitem:</label>
                <select class="form-control" id="subitem" disabled>
                    <option value="">Selecione um subitem</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary" disabled>Buscar Palavras-chave</button>
        </form>
        <div id="keywords">
            <h2>Principais Palavras-chave</h2>
            <ul id="keywords-list" class="list-group">
            </ul>
        </div>
        <div id="error-message" class="alert alert-danger" role="alert" style="display: none;">
            Erro ao buscar palavras-chave. Por favor, tente novamente.
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const categorySelect = document.getElementById('category');
            const subcategorySelect = document.getElementById('subcategory');
            const subitemSelect = document.getElementById('subitem');
            const submitButton = document.querySelector('button[type="submit"]');
            const keywordsList = document.getElementById('keywords-list');
            const errorMessage = document.getElementById('error-message');

            try {
                const categoriesResponse = await fetch('/categories');
                const categories = await categoriesResponse.json();
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error fetching categories:', error);
            }

            categorySelect.addEventListener('change', async function() {
                const categoryId = categorySelect.value;
                subcategorySelect.innerHTML = '<option value="">Selecione uma subcategoria</option>';
                subcategorySelect.disabled = true;
                subitemSelect.innerHTML = '<option value="">Selecione um subitem</option>';
                subitemSelect.disabled = true;
                submitButton.disabled = true;

                if (categoryId) {
                    try {
                        const subcategoriesResponse = await fetch(`/subcategories?category_id=${categoryId}`);
                        const subcategories = await subcategoriesResponse.json();
                        subcategories.forEach(subcategory => {
                            const option = document.createElement('option');
                            option.value = subcategory.id;
                            option.textContent = subcategory.name;
                            subcategorySelect.appendChild(option);
                        });
                        subcategorySelect.disabled = false;
                    } catch (error) {
                        console.error('Error fetching subcategories:', error);
                    }
                }
            });

            subcategorySelect.addEventListener('change', async function() {
                const subcategoryId = subcategorySelect.value;
                subitemSelect.innerHTML = '<option value="">Selecione um subitem</option>';
                subitemSelect.disabled = true;
                submitButton.disabled = true;

                if (subcategoryId) {
                    try {
                        const subitemsResponse = await fetch(`/subitems?subcategory_id=${subcategoryId}`);
                        const subitems = await subitemsResponse.json();
                        if (subitems.length > 0) {
                            subitems.forEach(subitem => {
                                const option = document.createElement('option');
                                option.value = subitem.id;
                                option.textContent = subitem.name;
                                subitemSelect.appendChild(option);
                            });
                            subitemSelect.disabled = false;
                        } else {
                            subitemSelect.disabled = true;
                            submitButton.disabled = false;
                        }
                    } catch (error) {
                        console.error('Error fetching subitems:', error);
                        submitButton.disabled = false;  // Allow search if fetching subitems fails
                    }
                }
            });

            subitemSelect.addEventListener('change', function() {
                submitButton.disabled = false;
            });

            document.getElementById('search-form').addEventListener('submit', async function(event) {
                event.preventDefault();
                const category = categorySelect.value;
                const subcategory = subcategorySelect.value;
                const subitem = subitemSelect.value;

                try {
                    const response = await fetch(`/keywords?category=${category}&subcategory=${subcategory}&subitem=${subitem}`);
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    const keywords = await response.json();

                    console.log('Keywords:', keywords);  // Log dos dados recebidos

                    keywordsList.innerHTML = '';
                    keywords.forEach(keyword => {
                        const listItem = document.createElement('li');
                        listItem.className = 'list-group-item';
                        listItem.textContent = `${keyword[0]}: ${keyword[1]}`;
                        keywordsList.appendChild(listItem);
                    });
                    errorMessage.style.display = 'none';  // Ocultar mensagem de erro
                } catch (error) {
                    console.error('Error fetching keywords:', error);
                    errorMessage.style.display = 'block';  // Mostrar mensagem de erro
                }
            });
        });
    </script>
</body>
</html>
