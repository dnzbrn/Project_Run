<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Anúncio</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"> <!-- FontAwesome para o ícone de copiar -->
    <style>
        /* Estilo para o layout */
        body {
            font-family: 'Helvetica Neue', sans-serif;
            background-color: #f5f5f7;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px;
        }

        h1 {
            font-size: 2.5em;
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }

        /* Layout da container do carrossel e informações */
        .container-custom {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            margin-top: 40px;
        }

        /* Carrossel */
        #carouselExampleControls {
            width: 600px;
            height: 600px;  /* Aumentando a altura do carrossel para 600px */
            margin-right: 30px;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .carousel-item img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Ajuste para que a imagem ocupe todo o espaço sem distorção */
        }

        /* Detalhes do anúncio */
        .ad-details {
            flex: 1;
            max-width: 500px;
            height: 600px;  /* Ajustando a altura da descrição para igualar com o carrossel */
            overflow: hidden; /* Garante que o conteúdo não saia da caixa */
            padding-top: 20px; /* Ajuste para alinhar com o carrossel */
        }

        .ad-details h2 {
            color: #333;
            font-size: 1.6em;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .ad-details h3 {
            color: #555;
            font-size: 1.3em;
            margin-bottom: 15px;
        }

        #ad-title {
            font-size: 1.2em;
            font-weight: bold;
            padding: 12px;
            border-radius: 10px;
            background-color: #fff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border: 1px solid #ddd;
        }

        #ad-description {
            font-size: 1em;
            line-height: 1.6;
            padding: 12px;
            border-radius: 10px;
            background-color: #fff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            border: 1px solid #ddd;
            height: calc(100% - 50px); /* Ajuste para ocupar o restante da altura */
            overflow-y: auto; /* Permite rolar o conteúdo se necessário */
        }

        /* Botão de copiar descrição */
        .copy-btn {
            background-color: #f5f5f7;
            border: none;
            cursor: pointer;
            color: #007aff;
            font-size: 1em;
            padding: 5px 10px;
            margin-top: 10px;
            transition: background-color 0.3s ease;
            display: flex;
            align-items: center;
        }

        .copy-btn:hover {
            background-color: #007aff;
            color: #fff;
        }

        .copy-btn i {
            margin-right: 5px;
        }

        /* Botão de gerar anúncio */
        #generate-ad {
            padding: 15px 25px;
            font-size: 1.2em;
            background-color: #007aff;
            color: #fff;
            border: none;
            border-radius: 25px;
            box-shadow: 0 4px 20px rgba(0, 122, 255, 0.2);
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-top: 40px;
        }

        #generate-ad:hover {
            background-color: #0051a8;
        }

        /* Formulário */
        .form-group label {
            font-size: 1.1em;
            font-weight: bold;
            color: #555;
        }

        .form-control {
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
        }

        /* Aumento da altura das subcategorias */
        select.form-control {
            height: 60px;  /* Aumento de 20% da altura dos selects */
        }

        /* Seção oculta inicialmente */
        .d-none {
            display: none;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Gerador de Anúncio</h1>
        
        <div class="centered-form">
            <form id="ad-form" class="text-center">
                <!-- Seleção de Categoria -->
                <div class="form-group">
                    <label for="category">Categoria:</label>
                    <select id="category" class="form-control">
                        <option value="">Carregando categorias...</option>
                    </select>
                </div>
                
                <!-- Seleção de Subcategoria -->
                <div class="form-group">
                    <label for="subcategory">Subcategoria:</label>
                    <select id="subcategory" class="form-control" disabled>
                        <option value="">Selecione uma subcategoria</option>
                    </select>
                </div>

                <!-- Seleção de Subitem -->
                <div class="form-group">
                    <label for="subitem">Subitem:</label>
                    <select id="subitem" class="form-control" disabled>
                        <option value="">Selecione um subitem</option>
                    </select>
                </div>
                
                <button type="button" class="btn" id="generate-ad">Gerar Anúncio</button>
            </form>
        </div>

        <!-- Layout com imagens e título -->
        <div class="container-custom">
            <!-- Carrossel para fotos (lado esquerdo) -->
            <div id="carouselExampleControls" class="carousel slide d-none" data-ride="carousel">
                <div class="carousel-inner" id="carousel-items">
                    <!-- Imagens serão inseridas aqui dinamicamente -->
                </div>
                <a class="carousel-control-prev" href="#carouselExampleControls" role="button" data-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="sr-only">Anterior</span>
                </a>
                <a class="carousel-control-next" href="#carouselExampleControls" role="button" data-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="sr-only">Próximo</span>
                </a>
            </div>

            <!-- Título e Descrição do Anúncio (lado direito) -->
            <div class="ad-details d-none">
                <h2>Título do Anúncio</h2>
                <input type="text" id="ad-title" class="form-control mb-3" readonly>

                <h3>Descrição do Anúncio</h3>
                <p id="ad-description">Aguarde... Gerando descrição completa do produto.</p>

                <!-- Botão de copiar descrição -->
                <button class="copy-btn" onclick="copyDescription()">
                    <i class="fas fa-copy"></i> Copiar descrição
                </button>
            </div>
        </div>
    </div>

    <script>
        // Função para copiar o conteúdo da descrição
        function copyDescription() {
            const descriptionText = document.getElementById('ad-description').innerText;
            const textarea = document.createElement('textarea');
            textarea.value = descriptionText;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            alert('Descrição copiada para a área de transferência!');
        }

        const categorySelect = document.getElementById("category");
        const subcategorySelect = document.getElementById("subcategory");
        const subitemSelect = document.getElementById("subitem");
        const adTitleInput = document.getElementById("ad-title");
        const adDescription = document.getElementById("ad-description");
        const carouselItems = document.getElementById("carousel-items");
        const carouselContainer = document.getElementById("carouselExampleControls");

        // Função para carregar categorias reais do Mercado Livre
        async function loadMercadoLivreCategories() {
            try {
                const response = await fetch("/mercadolivre-categories");
                if (!response.ok) {
                    throw new Error("Erro ao carregar categorias do Mercado Livre");
                }
                
                const categories = await response.json();

                // Atualiza o select com as categorias carregadas
                categorySelect.innerHTML = '<option value="">Selecione uma categoria</option>';
                for (const [name, id] of Object.entries(categories)) {
                    const option = document.createElement("option");
                    option.value = id;
                    option.dataset.name = name;
                    option.textContent = name;
                    categorySelect.appendChild(option);
                }
            } catch (error) {
                console.error("Erro ao carregar categorias do Mercado Livre:", error);
                categorySelect.innerHTML = '<option value="">Erro ao carregar categorias</option>';
            }
        }

        // Carregar subcategorias com base na categoria selecionada
        categorySelect.addEventListener("change", async function() {
            const selectedCategoryID = categorySelect.value;
            subcategorySelect.innerHTML = '<option value="">Selecione uma subcategoria</option>';
            subitemSelect.innerHTML = '<option value="">Selecione um subitem</option>';
            subcategorySelect.disabled = true;
            subitemSelect.disabled = true;

            if (selectedCategoryID) {
                try {
                    const response = await fetch(`https://api.mercadolibre.com/categories/${selectedCategoryID}`);
                    const categoryData = await response.json();

                    if (categoryData.children_categories.length > 0) {
                        categoryData.children_categories.forEach(subcat => {
                            const option = document.createElement("option");
                            option.value = subcat.id;
                            option.textContent = subcat.name;
                            subcategorySelect.appendChild(option);
                        });
                        subcategorySelect.disabled = false;
                    }
                } catch (error) {
                    console.error("Erro ao carregar subcategorias do Mercado Livre:", error);
                }
            }
        });

        // Carregar subitens com base na subcategoria selecionada
        subcategorySelect.addEventListener("change", async function() {
            const selectedSubcategoryID = subcategorySelect.value;
            subitemSelect.innerHTML = '<option value="">Selecione um subitem</option>';
            subitemSelect.disabled = true;

            if (selectedSubcategoryID) {
                try {
                    const response = await fetch(`https://api.mercadolibre.com/categories/${selectedSubcategoryID}`);
                    const subcategoryData = await response.json();

                    if (subcategoryData.children_categories.length > 0) {
                        subcategoryData.children_categories.forEach(subitem => {
                            const option = document.createElement("option");
                            option.value = subitem.id;
                            option.textContent = subitem.name;
                            subitemSelect.appendChild(option);
                        });
                        subitemSelect.disabled = false;
                    }
                } catch (error) {
                    console.error("Erro ao carregar subitens do Mercado Livre:", error);
                }
            }
        });

        // Geração do anúncio e solicitação de fotos ao clicar no botão
        document.getElementById("generate-ad").addEventListener("click", async function() {
            const selectedCategoryOption = categorySelect.options[categorySelect.selectedIndex];
            const categoryID = selectedCategoryOption.value;
            const categoryName = selectedCategoryOption.dataset.name || '';

            const selectedSubcategoryOption = subcategorySelect.options[subcategorySelect.selectedIndex];
            const subcategoryID = selectedSubcategoryOption ? selectedSubcategoryOption.value : '';
            const subcategoryName = selectedSubcategoryOption ? selectedSubcategoryOption.textContent : '';

            const selectedSubitemOption = subitemSelect.options[subitemSelect.selectedIndex];
            const subitemID = selectedSubitemOption ? selectedSubitemOption.value : '';
            const subitemName = selectedSubitemOption ? selectedSubitemOption.textContent : '';

            try {
                const response = await fetch('/generate-ad', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        category_name: categoryName,
                        category_id: categoryID,
                        subcategory_name: subcategoryName,
                        subcategory_id: subcategoryID,
                        subitem_name: subitemName,
                        subitem_id: subitemID
                    })
                });

                if (!response.ok) {
                    throw new Error("Erro ao gerar o anúncio: " + response.statusText);
                }

                const data = await response.json();
                
                if (data.photo_urls && data.photo_urls.length > 0) {
                    carouselItems.innerHTML = '';
                    data.photo_urls.forEach((url, index) => {
                        const item = document.createElement('div');
                        item.className = `carousel-item ${index === 0 ? 'active' : ''}`;
                        item.innerHTML = `<img src="${url}" class="d-block w-100" alt="Imagem do Produto">`;
                        carouselItems.appendChild(item);
                    });

                    carouselContainer.classList.remove('d-none');
                    $('#carouselExampleControls').carousel();
                } else {
                    alert("Nenhuma imagem encontrada para o termo de busca.");
                }

                adTitleInput.value = data.title || "Título não disponível";
                adDescription.textContent = data.description || "Descrição não disponível";
                
                document.querySelector('.ad-details').classList.remove('d-none');
            } catch (error) {
                console.error("Erro ao gerar anúncio:", error);
                alert("Ocorreu um erro ao gerar o anúncio. Verifique o console para mais detalhes.");
            }
        });

        // Carregar categorias ao iniciar
        document.addEventListener("DOMContentLoaded", loadMercadoLivreCategories);
    </script>

    <!-- Scripts do Bootstrap -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>
